!function(e){"use strict";function t(e,t,i,n){return new(i||(i=Promise))((function(s,r){function o(e){try{d(n.next(e))}catch(e){r(e)}}function a(e){try{d(n.throw(e))}catch(e){r(e)}}function d(e){var t;e.done?s(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(o,a)}d((n=n.apply(e,t||[])).next())}))}class i{static arrayBufferToBase64(e){return btoa(String.fromCharCode(...new Uint8Array(e)))}static base64ToArrayBuffer(e){return Uint8Array.from(atob(e),(e=>e.charCodeAt(0)))}}class n{constructor(e){this._getter=e,this._resolved=!1}get(){return this._valuePromise||(this._valuePromise=this._getter().then((e=>(this._resolved=!0,e)))),this._valuePromise}get resolved(){return this._resolved}}var s;function r(e,t="",i){return{errorCode:e,description:t,data:i}}!function(e){e.NotInitialized="not_initialized",e.UserNotFound="user_not_found",e.UserMismatch="user_mismatch",e.MissingPrepareStep="missing_prepare_step",e.RegistrationFailed="registration_failed",e.AuthenticationFailed="authentication_failed",e.InvalidAuthSession="invalid_auth_session",e.Unknown="unknown"}(s||(s={}));class o{static init(e){try{this._serverPath=new URL(e)}catch(e){throw r(s.NotInitialized,"Invalid options.serverPath",{error:e})}}static enrichHeaders(e){return Object.assign(Object.assign({},e.authSessionId&&{"x-ts-flow-id":e.authSessionId}),e.deviceBindingToken&&{"x-ts-device-binding-token":e.deviceBindingToken})}static startRestrictedSession(e){return t(this,void 0,void 0,(function*(){let t=new URL(this._serverPath);t.pathname+="v1/auth-session/start-restricted";let i=yield fetch(t.toString(),{method:"POST",headers:Object.assign({"Content-Type":"application/json"},this.enrichHeaders({})),body:JSON.stringify({client_id:e})});return yield i.json()}))}static startWebauthnRegistration(e,i,n,s){return t(this,void 0,void 0,(function*(){let t=new URL(this._serverPath);t.pathname+="v1/webauthn/register/start";let r=yield fetch(t.toString(),{method:"POST",headers:Object.assign({"Content-Type":"application/json"},this.enrichHeaders({authSessionId:e,deviceBindingToken:i})),body:JSON.stringify({auth_session_id:e,user:{username:n,display_name:s}})});return yield r.json()}))}static completeWebauthnRegistration(e,i,n,s){return t(this,void 0,void 0,(function*(){let t=new URL(this._serverPath);t.pathname+="v1/webauthn/register/complete";let r=yield fetch(t.toString(),{method:"POST",headers:Object.assign({"Content-Type":"application/json"},this.enrichHeaders({authSessionId:e,deviceBindingToken:i})),body:JSON.stringify({auth_session_id:e,webauthn_session_id:n,public_key_credential:s})});return yield r.json()}))}static startWebauthnAuthentication(e,i,n){return t(this,void 0,void 0,(function*(){let t=new URL(this._serverPath);t.pathname+="v1/webauthn/authenticate/start";let s=yield fetch(t.toString(),{method:"POST",headers:Object.assign({"Content-Type":"application/json"},this.enrichHeaders({authSessionId:e,deviceBindingToken:i})),body:JSON.stringify({auth_session_id:e,username:n})});return yield s.json()}))}static completeWebauthnAuthentication(e,i,n,s){return t(this,void 0,void 0,(function*(){let t=new URL(this._serverPath);t.pathname+="v1/webauthn/authenticate/complete";let r=yield fetch(t.toString(),{method:"POST",headers:Object.assign({"Content-Type":"application/json"},this.enrichHeaders({authSessionId:e,deviceBindingToken:i})),body:JSON.stringify({auth_session_id:e,webauthn_session_id:n,public_key_credential:s})});return yield r.json()}))}}class a{constructor(e,i,s){this.authSessionId=e,this.deviceBindingToken=i,this.startAuthenticationResponse=new n((()=>t(this,void 0,void 0,(function*(){return yield o.startWebauthnAuthentication(this.authSessionId,this.deviceBindingToken,s)}))))}get isReady(){return this.startAuthenticationResponse.resolved}prepare(){return t(this,void 0,void 0,(function*(){yield this.startAuthenticationResponse.get()}))}execute(){return t(this,void 0,void 0,(function*(){const e=yield this.startAuthenticationResponse.get(),t=e.credential_request_options;t.challenge=i.base64ToArrayBuffer(t.challenge),t.allowCredentials=t.allowCredentials.map((e=>Object.assign(Object.assign({},e),{id:i.base64ToArrayBuffer(e.id)})));const n=yield navigator.credentials.get({publicKey:t}),s=n.response,r={id:n.id,rawId:i.arrayBufferToBase64(n.rawId),response:{authenticatorData:i.arrayBufferToBase64(s.authenticatorData),clientDataJSON:i.arrayBufferToBase64(s.clientDataJSON),signature:i.arrayBufferToBase64(s.signature),userHandle:i.arrayBufferToBase64(s.userHandle)},type:n.type};let a=yield o.completeWebauthnAuthentication(this.authSessionId,this.deviceBindingToken,e.webauthn_session_id,r);this.result=a.auth_code}))}}class d{constructor(e,i,s,r){this.authSessionId=e,this.deviceBindingToken=i,this.startRegistrationResponse=new n((()=>t(this,void 0,void 0,(function*(){return yield o.startWebauthnRegistration(this.authSessionId,this.deviceBindingToken,s,r)}))))}get isReady(){return this.startRegistrationResponse.resolved}prepare(){return t(this,void 0,void 0,(function*(){yield this.startRegistrationResponse.get()}))}execute(){return t(this,void 0,void 0,(function*(){const e=yield this.startRegistrationResponse.get(),t=e.credential_creation_options;t.challenge=i.base64ToArrayBuffer(t.challenge),t.user.id=i.base64ToArrayBuffer(t.user.id),t.excludeCredentials=t.excludeCredentials.map((e=>({id:i.base64ToArrayBuffer(e.id),type:e.type})));const n=yield navigator.credentials.create({publicKey:t}),s=n.response,r={id:n.id,rawId:i.arrayBufferToBase64(n.rawId),response:{attestationObject:i.arrayBufferToBase64(s.attestationObject),clientDataJSON:i.arrayBufferToBase64(s.clientDataJSON)},type:n.type};let a=yield o.completeWebauthnRegistration(this.authSessionId,this.deviceBindingToken,e.webauthn_session_id,r);this.result=a.auth_code}))}}const c={log:console.log,error:console.error};var h;!function(e){e[e.persistent=0]="persistent",e[e.session=1]="session"}(h||(h={}));class u{static get(e){return u.getStorageMedium(u.allowedKeys[e]).getItem(u.getStorageKey(e))||void 0}static set(e,t){return u.getStorageMedium(u.allowedKeys[e]).setItem(u.getStorageKey(e),t)}static clear(){for(const[e,t]of Object.entries(u.allowedKeys))u.getStorageMedium(t).removeItem(u.getStorageKey(e))}static getStorageKey(e){return`WebAuthnSdk:${e}`}static getStorageMedium(e){switch(e){case h.persistent:return localStorage;case h.session:return sessionStorage}}}u.allowedKeys={authSessionId:h.session,clientId:h.session,deviceBindingToken:h.session};class l{constructor(){this._initialized=!1}init(e,i){return t(this,void 0,void 0,(function*(){try{if(this._clearSdkSessionState(),o.init(i.serverPath),!e)throw r(s.NotInitialized,"Invalid clientId",{clientId:e});u.set("clientId",e),this._initialized=!0}catch(e){throw"string"==typeof(t=e).errorCode&&"string"==typeof t.description?e:r(s.NotInitialized,"Something went wrong",{error:e})}var t}))}_clearSdkSessionState(){this._initialized=!1,u.clear(),this._currentRegistrationSession=void 0,this._currentAuthenticationSession=void 0}isPlatformAuthenticatorSupported(){return t(this,void 0,void 0,(function*(){try{return yield PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()}catch(e){return c.error(e),!1}}))}getDeviceUsers(){throw new Error("Method not implemented.")}prepareWebauthnRegistration(e,i,n,o){return t(this,void 0,void 0,(function*(){if(!this._initialized)throw r(s.NotInitialized);if(!n&&o)throw r(s.InvalidAuthSession,"authSessionId was not provided");if(!o&&n)throw r(s.InvalidAuthSession,"deviceBindingToken was not provided");if(n&&o)u.set("authSessionId",n),u.set("deviceBindingToken",o);else{if(n=u.get("authSessionId"),o=u.get("deviceBindingToken"),!n)throw r(s.InvalidAuthSession,"authSessionId was not provided");if(!o)throw r(s.InvalidAuthSession,"deviceBindingToken was not provided")}return this._currentRegistrationSession=new d(n,o,e,null!=i?i:e),yield this._currentRegistrationSession.prepare()}))}executeWebauthnRegistration(){return t(this,void 0,void 0,(function*(){if(!this._initialized)throw r(s.NotInitialized);if(!this._currentRegistrationSession||!this._currentRegistrationSession.isReady)throw r(s.MissingPrepareStep,"executeWebauthnRegistration() cannot be called before prepareWebauthnRegistration() has completed successfully");yield this._currentRegistrationSession.execute();const e=this._currentRegistrationSession.result;return this._currentRegistrationSession=void 0,e}))}prepareWebauthnAuthentication(e){return t(this,void 0,void 0,(function*(){if(!this._initialized)throw r(s.NotInitialized);let t=u.get("authSessionId"),i=u.get("deviceBindingToken");return t&&i||(({auth_session_id:t,device_binding_token:i}=yield o.startRestrictedSession(u.get("clientId"))),u.set("authSessionId",t),u.set("deviceBindingToken",i)),this._currentAuthenticationSession=new a(t,i,e),yield this._currentAuthenticationSession.prepare()}))}executeWebauthnAuthentication(){return t(this,void 0,void 0,(function*(){if(!this._initialized)throw r(s.NotInitialized);if(!this._currentAuthenticationSession)throw r(s.MissingPrepareStep,"executeWebauthnAuthentication() cannot be called before prepareWebauthnAuthentication() has completed successfully");yield this._currentAuthenticationSession.execute();const e=this._currentAuthenticationSession.result;return this._currentAuthenticationSession=void 0,e}))}startCrossDeviceFlow(e,t){throw new Error("Method not implemented.")}attachDevice(e){throw new Error("Method not implemented.")}detachDevice(){throw new Error("Method not implemented.")}}globalThis.WebAuthnSdk=new l,e.WebAuthnSdkImpl=l,Object.defineProperty(e,"__esModule",{value:!0})}({});
